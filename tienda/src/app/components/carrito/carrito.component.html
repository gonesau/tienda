<!-- carrito.component.html - CORREGIDO -->
<app-nav></app-nav>

<main class="cs-page-wrapper">
  <!-- Breadcrumb -->
  <nav class="bg-secondary mb-3" aria-label="breadcrumb">
    <div class="container">
      <ol class="breadcrumb breadcrumb-alt mb-0">
        <li class="breadcrumb-item">
          <a href="index.html"><i class="cxi-home"></i></a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
      </ol>
    </div>
  </nav>

  <!-- Page content -->
  <section class="container pt-3 pt-md-4 pb-3 pb-sm-4 pb-lg-5 mb-4">
    <div class="row">

      <!-- Checkout content -->
      <div class="col-lg-8 pr-lg-6">
        <div class="d-flex align-items-center justify-content-between pb-2 mb-4">
          <h1 class="mb-0">Checkout</h1>
          <a [routerLink]="['/productos']"><strong>Regresar a la tienda</strong></a>
        </div>

        <hr class="border-top-0 border-bottom pt-2 mb-4">

        <!-- Order review -->
        <h2 class="h4 mb-4">1. Detalles de compra</h2>

        <!-- Spinner de carga -->
        <div class="text-center py-5" *ngIf="load_data">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando carrito...</span>
          </div>
          <p class="mt-3 text-muted">Cargando productos...</p>
        </div>

        <!-- Carrito vacío -->
        <div class="alert alert-info" role="alert" *ngIf="!load_data && carrito_compras.length === 0">
          <div class="d-flex align-items-center">
            <i class="cxi-shopping-bag font-size-xl mr-3"></i>
            <div>
              <strong>Tu carrito está vacío</strong>
              <p class="mb-0 mt-1">Agrega productos para continuar con tu compra.</p>
            </div>
          </div>
          <a [routerLink]="['/productos']" class="btn btn-primary mt-3">
            <i class="cxi-arrow-left mr-2"></i>
            Ir a la tienda
          </a>
        </div>

        <!-- Lista de productos -->
        <div class="bg-secondary rounded mb-5" *ngIf="!load_data && carrito_compras.length > 0">
          <!-- Item -->
          <div class="media px-2 px-sm-4 py-4 border-bottom" *ngFor="let item of carrito_compras">
            <a [routerLink]="['/productos/', item.producto.slug]" style="min-width: 80px;">
              <img [src]="url + 'obtener_portada/' + item.producto.portada" width="80" alt="Product thumb">
            </a>
            <div class="media-body w-100 pl-3">
              <div class="d-sm-flex">
                <div class="pr-sm-3 w-100" style="max-width: 16rem;">
                  <h3 class="font-size-sm mb-3">
                    <a [routerLink]="['/productos/', item.producto.slug]" class="nav-link font-weight-bold">{{
                      item.producto.titulo }}</a>
                  </h3>
                  <ul class="list-unstyled font-size-xs mt-n2 mb-2">
                    <li class="mb-0"><span class="text-muted">{{item.producto.titulo_variedad}}: </span>
                      {{item.variedad}}</li>
                    <li class="mb-0"><span class="text-muted">Stock disponible: </span>
                      {{item.producto.stock}} unidades</li>
                  </ul>
                </div>
                
                <!-- Control de cantidad y precio -->
                <div class="d-flex flex-column pr-sm-3">
                  <!-- Control de cantidad mejorado -->
                  <div class="d-flex align-items-center mb-2">
                    <div class="input-group" style="width: 130px;">
                      <div class="input-group-prepend">
                        <button class="btn btn-outline-secondary btn-sm" type="button"
                          (click)="cambiar_cantidad(item, item.cantidad - 1)"
                          [disabled]="item.cantidad <= 1 || actualizando_cantidad[item._id]"
                          style="padding: 0.25rem 0.5rem;">
                          <i class="cxi-minus"></i>
                        </button>
                      </div>
                      <input 
                        type="number" 
                        class="form-control form-control-sm text-center font-weight-bold"
                        style="font-size: 0.95rem; padding: 0.25rem;"
                        [value]="item.cantidad" 
                        min="1" 
                        [max]="item.producto.stock"
                        (change)="cambiar_cantidad(item, $event.target.value)"
                        [disabled]="actualizando_cantidad[item._id]">
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary btn-sm" type="button"
                          (click)="cambiar_cantidad(item, item.cantidad + 1)"
                          [disabled]="item.cantidad >= item.producto.stock || actualizando_cantidad[item._id]"
                          style="padding: 0.25rem 0.5rem;">
                          <i class="cxi-plus"></i>
                        </button>
                      </div>
                    </div>

                    <!-- Spinner de actualización -->
                    <div class="ml-2" *ngIf="actualizando_cantidad[item._id]">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="sr-only">Actualizando...</span>
                      </div>
                    </div>
                  </div>

                  <!-- Precio -->
                  <div class="text-left">
                    <span class="font-size-base font-weight-bold d-block">{{ item.producto.precio * item.cantidad | currency }}</span>
                    <small class="text-muted">{{ item.producto.precio | currency }} c/u</small>
                  </div>
                </div>

                <!-- Botones de acción -->
                <div class="d-flex align-items-center flex-sm-column text-sm-center ml-sm-auto pt-3 pt-sm-0">
                  <button class="btn btn-outline-primary btn-sm mr-2 mr-sm-0 mb-sm-2" 
                    (click)="eliminar_item(item._id)"
                    [disabled]="actualizando_cantidad[item._id]">
                    Eliminar
                  </button>
                  <button class="btn btn-link btn-sm text-decoration-none px-0 pb-0">
                    Agregar a favoritos
                    <i class="cxi-heart ml-1"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dirección de envío -->
        <h2 class="h4 mb-4">2. Dirección de envío</h2>
        <div class="row pb-3">
          <div class="col-12">

            <!-- Spinner de carga de dirección -->
            <div class="text-center py-4" *ngIf="load_direccion">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando dirección...</span>
              </div>
              <p class="mt-2 text-muted mb-0">Verificando dirección de envío...</p>
            </div>

            <!-- Sin dirección principal -->
            <div class="card border-warning" *ngIf="!load_direccion && direccion_principal === undefined">
              <div class="card-body">
                <div class="alert alert-warning mb-3" role="alert">
                  <div class="d-flex">
                    <i class="cxi-info-circle font-size-lg mr-3"></i>
                    <div>
                      <strong>No tienes una dirección principal configurada</strong>
                      <p class="mb-0 mt-1">Necesitas agregar una dirección de envío para continuar con tu compra.</p>
                    </div>
                  </div>
                </div>
                <a [routerLink]="['/cuenta/direcciones']" class="btn btn-primary">
                  <i class="cxi-location mr-2"></i>
                  Agregar dirección de envío
                </a>
              </div>
            </div>

            <!-- Con dirección principal -->
            <div class="card border-success" *ngIf="!load_direccion && direccion_principal !== undefined">
              <div class="card-header text-white d-flex justify-content-between align-items-center"
                style="background-color: #17696a !important;">
                <h5 class="mb-0 text-white">
                  <i class="cxi-check-circle mr-2"></i>
                  Dirección Principal de Envío
                </h5>
                <a [routerLink]="['/cuenta/direcciones']" class="btn btn-sm btn-light">
                  <i class="cxi-edit mr-1"></i>
                  Cambiar
                </a>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-user mr-2"></i>
                      Destinatario
                    </h6>
                    <p class="mb-0 font-weight-medium">{{direccion_principal.destinatario}}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-phone mr-2"></i>
                      Teléfono
                    </h6>
                    <p class="mb-0 font-weight-medium">{{direccion_principal.telefono}}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-user-circle mr-2"></i>
                      DUI
                    </h6>
                    <p class="mb-0 font-weight-medium">{{direccion_principal.dui}}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-mail mr-2"></i>
                      Código Postal
                    </h6>
                    <p class="mb-0 font-weight-medium">{{direccion_principal.zip}}</p>
                  </div>
                  <div class="col-12 mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-location mr-2"></i>
                      Dirección Completa
                    </h6>
                    <p class="mb-0 font-weight-medium">{{direccion_principal.direccion}}</p>
                  </div>
                  <div class="col-12">
                    <h6 class="text-muted mb-2">
                      <i class="cxi-flag mr-2"></i>
                      Ubicación
                    </h6>
                    <p class="mb-0 font-weight-medium">
                      {{direccion_principal.pais}}
                      <span *ngIf="direccion_principal.municipio">
                        , {{direccion_principal.municipio}}
                      </span>
                      <span *ngIf="direccion_principal.departamento">
                        , {{direccion_principal.departamento}}
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr class="mb-4 pb-2">

        <!-- Métodos de envío -->
        <h2 class="h4 mb-4">3. Método de envío</h2>

        <!-- Spinner de carga de envíos -->
        <div class="text-center py-3" *ngIf="envios.length === 0">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Cargando métodos de envío...</span>
          </div>
          <p class="mt-2 text-muted mb-0 font-size-sm">Cargando opciones de envío...</p>
        </div>

        <!-- Lista de métodos de envío -->
        <div *ngIf="envios.length > 0">
          <div class="custom-control custom-radio mb-3" *ngFor="let envio of envios; let i = index">
            <input type="radio" class="custom-control-input" [id]="'envio-' + i" name="metodo_envio"
              [value]="envio.costo" [checked]="envio_seleccionado && envio_seleccionado.titulo === envio.titulo"
              (change)="onEnvioChange(envio)">
            <label [for]="'envio-' + i" class="custom-control-label d-flex align-items-center cursor-pointer">
              <span class="flex-grow-1">
                <strong class="d-block">{{envio.titulo}}</strong>
                <span class="text-muted font-size-sm">{{envio.tiempo}}</span>
              </span>
              <span class="ml-auto font-weight-bold text-primary">{{envio.costo | currency}}</span>
            </label>
          </div>
        </div>

        <hr class="border-top-0 border-bottom pt-4 mb-4">

        <!-- Payment -->
        <h2 class="h4 pt-2 mb-4">4. Método de Pago</h2>
        <div class="row pb-4">
          <div class="col-lg-7">
            <div class="accordion-alt" id="payment-methods">

              <!-- Card: Credit card -->
              <div class="card mb-3 px-4 py-3 border rounded box-shadow-sm">
                <div class="card-header py-2">
                  <div class="accordion-heading custom-control custom-radio" data-toggle="collapse"
                    data-target="#cc-card">
                    <input type="radio" class="custom-control-input" id="cc" name="payment" checked>
                    <label for="cc" class="custom-control-label d-flex align-items-center">
                      <strong class="d-block mr-3">Tarjeta de crédito</strong>
                      <img src="../../../assets/img/cards.png" width="108" alt="Credit cards">
                    </label>
                  </div>
                </div>
                <div class="collapse show" id="cc-card" data-parent="#payment-methods">
                  <div class="card-body pt-3 pb-0">
                    <div class="form-group mb-3">
                      <label for="cc-number">Número de tarjeta</label>
                      <input type="text" id="cc-number" class="form-control form-control-lg" data-format="card"
                        placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="d-flex">
                      <div class="form-group mb-3 mr-3">
                        <label for="cc-exp-date">Fecha de expiración</label>
                        <input type="text" id="cc-exp-date" class="form-control form-control-lg" data-format="date"
                          placeholder="mm/yy">
                      </div>
                      <div class="form-group mb-3">
                        <label for="cc-cvc">CVC</label>
                        <input type="text" id="cc-cvc" class="form-control form-control-lg" data-format="cvc"
                          placeholder="000">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Card: PayPal -->
              <div class="card mb-3 px-4 py-3 border rounded box-shadow-sm">
                <div class="card-header py-2">
                  <div class="accordion-heading custom-control custom-radio" data-toggle="collapse"
                    data-target="#paypal-card">
                    <input type="radio" class="custom-control-input" id="paypal" name="payment">
                    <label for="paypal" class="custom-control-label d-flex align-items-center">
                      <strong class="d-block mr-3">PayPal</strong>
                      <img src="../../../assets/img/pay-pal.jpg" width="48" alt="PayPal">
                    </label>
                  </div>
                </div>
                <div class="collapse" id="paypal-card" data-parent="#payment-methods">
                  <div class="card-body pt-3 pb-0">
                    <p class="mb-2 text-muted">Serás redirigido a PayPal para completar tu compra de forma segura.</p>
                    <!-- Contenedor de botones PayPal -->
                    <div #paypalButton id="paypal-button-container"></div>
                  </div>
                </div>
              </div>

              <!-- Card: Cash -->
              <div class="card mb-3 px-4 py-3 border rounded box-shadow-sm">
                <div class="card-header py-2">
                  <div class="accordion-heading custom-control custom-radio" data-toggle="collapse"
                    data-target="#cash-card">
                    <input type="radio" class="custom-control-input" id="cash" name="payment">
                    <label for="cash" class="custom-control-label">
                      <strong class="d-block mr-3">Pago contra entrega</strong>
                    </label>
                  </div>
                </div>
                <div class="collapse" id="cash-card" data-parent="#payment-methods">
                  <div class="card-body pt-3 pb-0">
                    <p class="mb-2 text-muted">Pagarás en efectivo al recibir tu pedido.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr class="mb-4 pb-2">

        <!-- Additional info -->
        <h2 class="h4 mb-4">5. Información Adicional (opcional)</h2>
        <div class="form-group">
          <label for="ch-notes">Notas del pedido</label>
          <textarea id="ch-notes" name="nota" [(ngModel)]="venta.nota" class="form-control form-control-lg" rows="5"
            placeholder="Notas sobre tu pedido, por ejemplo, instrucciones especiales para la entrega."></textarea>
        </div>
      </div>

      <!-- Order totals (sticky sidebar) -->
      <aside class="col-lg-4">
        <div class="sidebar-sticky">
          <div class="sidebar-sticky-inner">
            <!-- Sección de cupón mejorada -->
            <div class="form-group">
              <label for="promo-code">Aplicar cupón de descuento</label>
              <div class="input-group input-group-lg">
                <input type="text" id="promo-code" class="form-control text-uppercase" placeholder="Ingresa el código"
                  name="cupon" [(ngModel)]="venta.cupon" [disabled]="btn_aplicar_cupon || cupon_aplicado"
                  maxlength="20">
                <div class="input-group-append">
                  <button *ngIf="!cupon_aplicado" type="button" class="btn btn-primary" (click)="aplicar_cupon()"
                    [disabled]="btn_aplicar_cupon || !venta.cupon || cupon_aplicado">
                    <span *ngIf="!btn_aplicar_cupon">Aplicar</span>
                    <span *ngIf="btn_aplicar_cupon">
                      <span class="spinner-border spinner-border-sm mr-1"></span>
                      Validando...
                    </span>
                  </button>
                  <button *ngIf="cupon_aplicado" type="button" class="btn btn-danger" (click)="quitar_cupon()">
                    <i class="cxi-close mr-1"></i>
                    Quitar
                  </button>
                </div>
              </div>
              <small class="text-success d-block mt-2" *ngIf="cupon_aplicado">
                <i class="cxi-check-circle mr-1"></i>
                Cupón aplicado: <strong>{{cupon_aplicado.codigo}}</strong>
                ({{cupon_aplicado.tipo === 'Porcentaje' ? cupon_aplicado.valor + '%' : (cupon_aplicado.valor | currency)}}
                de descuento)
              </small>
            </div>

            <!-- Resumen del pedido -->
            <div class="bg-secondary rounded mb-4">
              <div class="border-bottom p-4">
                <h2 class="h4 mb-0">Resumen del Pedido</h2>
              </div>
              <ul class="list-unstyled border-bottom mb-0 p-4">
                <li class="d-flex justify-content-between mb-2">
                  <span class="font-weight-bold">Subtotal:</span>
                  <span class="font-weight-bold">{{ subtotal | currency }}</span>
                </li>
                <li class="d-flex justify-content-between mb-2">
                  <span>Envío:</span>
                  <span>{{precio_envio | currency }}</span>
                </li>
                <li class="d-flex justify-content-between mb-2" *ngIf="descuento_cupon > 0">
                  <span>Descuento:</span>
                  <span class="text-success">-{{descuento_cupon | currency}}</span>
                </li>
              </ul>
              <div class="d-flex justify-content-between p-4">
                <span class="h5 mb-0">Total a pagar:</span>
                <span class="h5 mb-0 text-primary">{{ total_pagar | currency }}</span>
              </div>
            </div>

            <!-- Mensaje informativo -->
            <div class="alert alert-info mt-3 mb-0" role="alert" *ngIf="carrito_compras.length > 0">
              <small class="mb-0">
                <i class="cxi-shield-check mr-1"></i>
                <strong>Compra segura</strong> - Tus datos están protegidos con PayPal
              </small>
            </div>

            <!-- Estado de procesamiento -->
            <div class="alert alert-success mt-3 mb-0" role="alert" *ngIf="load_btn_pagar">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm mr-3" role="status"></div>
                <div>
                  <strong>Procesando tu compra...</strong>
                  <p class="mb-0 mt-1 font-size-sm">Por favor espera, no cierres esta ventana.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>
</main>
<app-footer></app-footer>