<app-sidebar></app-sidebar>

<main class="admin-content">
  <div class="admin-main">
    
    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3 border-bottom">
      <div class="mb-3 mb-md-0">
        <h1 class="h2 mb-2">Editar Cupón</h1>
        <p class="text-muted mb-0" *ngIf="cupon">
          Modificando: {{ cupon.codigo }}
        </p>
      </div>
      <a class="btn btn-outline-secondary" [routerLink]="['/panel/cupones']">
        <i class="fas fa-arrow-left me-2"></i>Volver
      </a>
    </div>

    <!-- Loading State -->
    <div class="card" *ngIf="load_data">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted mb-0">Cargando datos del cupón...</p>
      </div>
    </div>

    <!-- Cupón no encontrado -->
    <div class="card" *ngIf="!cupon && !load_data">
      <div class="card-body text-center py-5">
        <i class="fas fa-ticket-alt text-muted mb-3" style="font-size: 4rem; display: block;"></i>
        <h4 class="mb-3">Cupón no encontrado</h4>
        <p class="text-muted mb-4">El cupón que buscas no existe o fue eliminado</p>
        <a class="btn btn-primary" [routerLink]="['/panel/cupones']">
          <i class="fas fa-arrow-left me-2"></i>Volver a Cupones
        </a>
      </div>
    </div>

    <!-- Formulario -->
    <form #actualizarForm="ngForm" (ngSubmit)="actualizar(actualizarForm)" novalidate *ngIf="cupon && !load_data">
      
      <div class="row g-4">
        
        <!-- Columna Principal -->
        <div class="col-lg-8">
          
          <!-- Información del Cupón -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-ticket-alt me-2 text-primary"></i>Detalles del Cupón
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                
                <!-- Código del Cupón (No editable) -->
                <div class="col-md-6">
                  <label for="codigo" class="form-label">
                    Código del Cupón
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-tag text-muted"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control"
                      id="codigo"
                      name="codigo"
                      [(ngModel)]="cupon.codigo"
                      disabled
                      readonly
                    />
                  </div>
                  <small class="form-text text-muted">El código no se puede modificar</small>
                </div>

                <!-- Tipo de Cupón -->
                <div class="col-md-6">
                  <label for="tipo" class="form-label">
                    Tipo de Descuento <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    id="tipo"
                    name="tipo"
                    required
                    [(ngModel)]="cupon.tipo"
                    #tipo="ngModel"
                    [class.is-invalid]="tipo.invalid && tipo.touched">
                    <option value="">Seleccionar...</option>
                    <option value="Porcentaje">Porcentaje (%)</option>
                    <option value="Valor fijo">Valor Fijo ($)</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="tipo.invalid && tipo.touched">
                    <small>El tipo de descuento es requerido</small>
                  </div>
                </div>

                <!-- Valor del Descuento -->
                <div class="col-md-6">
                  <label for="valor" class="form-label">
                    Valor del Descuento <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text" *ngIf="cupon.tipo === 'Valor fijo'">
                      <i class="fas fa-dollar-sign text-muted"></i>
                    </span>
                    <span class="input-group-text" *ngIf="cupon.tipo === 'Porcentaje'">
                      <i class="fas fa-percent text-muted"></i>
                    </span>
                    <input
                      type="number"
                      class="form-control"
                      id="valor"
                      name="valor"
                      placeholder="Ej: 25"
                      required
                      min="1"
                      [max]="cupon.tipo === 'Porcentaje' ? 100 : undefined"
                      step="0.01"
                      [(ngModel)]="cupon.valor"
                      #valor="ngModel"
                      [class.is-invalid]="valor.invalid && valor.touched"
                    />
                    <span class="input-group-text" *ngIf="cupon.tipo === 'Porcentaje'">%</span>
                    <span class="input-group-text" *ngIf="cupon.tipo === 'Valor fijo'">USD</span>
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="valor.invalid && valor.touched">
                    <small *ngIf="valor.errors?.['required']">El valor es requerido</small>
                    <small *ngIf="valor.errors?.['min']">El valor debe ser mayor a 0</small>
                    <small *ngIf="valor.errors?.['max']">El porcentaje no puede ser mayor a 100</small>
                  </div>
                </div>

                <!-- Límite de Usos -->
                <div class="col-md-6">
                  <label for="limite" class="form-label">
                    Límite de Usos <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-users text-muted"></i>
                    </span>
                    <input
                      type="number"
                      class="form-control"
                      id="limite"
                      name="limite"
                      placeholder="Ej: 100"
                      required
                      min="0"
                      [(ngModel)]="cupon.limite"
                      #limite="ngModel"
                      [class.is-invalid]="limite.invalid && limite.touched"
                    />
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="limite.invalid && limite.touched">
                    <small *ngIf="limite.errors?.['required']">El límite es requerido</small>
                    <small *ngIf="limite.errors?.['min']">Debe ser 0 o mayor</small>
                  </div>
                  <small class="form-text text-muted">Cantidad de usos restantes</small>
                </div>

              </div>
            </div>
          </div>

          <!-- Información Adicional -->
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2 text-primary"></i>Información
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning mb-0">
                <h6 class="alert-heading d-flex align-items-center">
                  <i class="fas fa-exclamation-triangle me-2"></i>Notas importantes
                </h6>
                <hr>
                <ul class="mb-0 small">
                  <li class="mb-2">
                    <strong>Código inmutable:</strong> El código del cupón no puede ser modificado una vez creado
                  </li>
                  <li class="mb-2">
                    <strong>Límite de usos:</strong> Puedes aumentar o disminuir el límite según necesites
                  </li>
                  <li class="mb-2">
                    <strong>Desactivar cupón:</strong> Para desactivarlo temporalmente, establece el límite en 0
                  </li>
                  <li>
                    <strong>Cambio de valor:</strong> Ten cuidado al cambiar el valor, esto afectará a todos los usos futuros
                  </li>
                </ul>
              </div>
            </div>
          </div>

        </div>

        <!-- Columna Lateral -->
        <div class="col-lg-4">

          <!-- Estadísticas -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2 text-primary"></i>Estadísticas
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3 text-center">
                <div class="col-12">
                  <div class="border rounded p-3">
                    <i class="fas fa-ticket-alt fa-2x text-primary mb-2"></i>
                    <h4 class="mb-0">{{ cupon.limite }}</h4>
                    <small class="text-muted">Usos Restantes</small>
                  </div>
                </div>
              </div>
              
              <hr>
              
              <div class="small text-muted">
                <div class="d-flex justify-content-between mb-2" *ngIf="cupon.createdAt">
                  <span>Creado:</span>
                  <span class="fw-semibold">{{ cupon.createdAt | date: 'dd/MM/yyyy' }}</span>
                </div>
                <div class="d-flex justify-content-between" *ngIf="cupon._id">
                  <span>ID:</span>
                  <span class="fw-semibold font-monospace small">{{ cupon._id.substring(0, 8) }}...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Preview del Cupón -->
          <div class="card mb-4" *ngIf="cupon.codigo && cupon.tipo && cupon.valor">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-eye me-2 text-primary"></i>Vista Previa
              </h5>
            </div>
            <div class="card-body">
              <div class="discount-preview">
                <div class="mb-3">
                  <i class="fas fa-gift fa-3x mb-2 opacity-75"></i>
                </div>
                <h3 class="fw-bold mb-2">{{ cupon.codigo }}</h3>
                <div class="display-1 my-3">
                  <span *ngIf="cupon.tipo === 'Porcentaje'">{{ cupon.valor }}%</span>
                  <span *ngIf="cupon.tipo === 'Valor fijo'">{{ cupon.valor | currency:'USD':'symbol':'1.0-2' }}</span>
                </div>
                <span class="badge bg-white text-dark">
                  {{ cupon.tipo }} de descuento
                </span>
                <hr class="my-3 border-white opacity-25">
                <p class="small mb-0 opacity-75">
                  <i class="fas fa-ticket-alt me-2"></i>
                  {{ cupon.limite }} usos disponibles
                </p>
              </div>
            </div>
          </div>

          <!-- Card de Acciones -->
          <div class="card sticky-top" style="top: 90px;">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-save me-2"></i>Actualizar Cupón
              </h5>
            </div>
            <div class="card-body">
              
              <!-- Validación del formulario -->
              <div class="alert alert-info mb-3" *ngIf="actualizarForm.invalid && actualizarForm.touched">
                <i class="fas fa-info-circle me-2"></i>
                <small>Completa todos los campos requeridos marcados con <span class="text-danger">*</span></small>
              </div>

              <!-- Botones de acción -->
              <div class="d-grid gap-2">
                <button
                  type="submit"
                  class="btn btn-warning btn-lg text-dark"
                  [disabled]="actualizarForm.invalid || load_btn">
                  <span *ngIf="!load_btn">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                  </span>
                  <span *ngIf="load_btn">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Guardando...
                  </span>
                </button>
                
                <a class="btn btn-outline-secondary" [routerLink]="['/panel/cupones']">
                  <i class="fas fa-times me-2"></i>Cancelar
                </a>
              </div>

              <!-- Información adicional -->
              <hr class="my-3">
              <div class="small text-muted">
                <p class="mb-2">
                  <i class="fas fa-asterisk fa-xs me-2"></i>
                  Los campos marcados son obligatorios
                </p>
                <p class="mb-0">
                  <i class="fas fa-shield-alt fa-xs me-2"></i>
                  Los cambios se aplicarán inmediatamente
                </p>
              </div>

            </div>
          </div>

        </div>

      </div>

    </form>

  </div>
</main>