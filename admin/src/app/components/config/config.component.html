<app-sidebar></app-sidebar>

<main class="admin-content">
  <div class="admin-main">
    
    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3 border-bottom">
      <div class="mb-3 mb-md-0">
        <h1 class="h2 mb-2">Configuración General</h1>
        <p class="text-muted mb-0">Administra los parámetros globales de tu tienda</p>
      </div>
    </div>

    <!-- Loading State -->
    <div class="card" *ngIf="load_data">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted mb-0">Cargando configuración...</p>
      </div>
    </div>

    <!-- Config no encontrada -->
    <div class="card" *ngIf="!config && !load_data">
      <div class="card-body text-center py-5">
        <i class="fas fa-exclamation-triangle text-danger mb-3" style="font-size: 4rem; display: block;"></i>
        <h4 class="mb-3">Error al cargar configuración</h4>
        <p class="text-muted mb-4">No se pudo cargar la configuración del sistema. Por favor, intenta de nuevo más tarde.</p>
        <button class="btn btn-primary" (click)="init_data()">
          <i class="fas fa-sync-alt me-2"></i>Reintentar
        </button>
      </div>
    </div>

    <!-- Formulario -->
    <form #confForm="ngForm" (ngSubmit)="actualizar(confForm)" novalidate *ngIf="config && !load_data">
      
      <div class="row g-4">
        
        <!-- Columna Principal -->
        <div class="col-lg-8">
          
          <!-- Información General -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-store me-2 text-primary"></i>Información de la Tienda
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                
                <!-- Nombre de la tienda -->
                <div class="col-12">
                  <label for="titulo" class="form-label">
                    Nombre de la Tienda <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-store text-muted"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control"
                      id="titulo"
                      name="titulo"
                      placeholder="Mi Tienda Ecommerce"
                      required
                      minlength="3"
                      [(ngModel)]="config.titulo"
                      #titulo="ngModel"
                      [class.is-invalid]="titulo.invalid && titulo.touched"
                    />
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="titulo.invalid && titulo.touched">
                    <small *ngIf="titulo.errors?.['required']">El nombre de la tienda es requerido</small>
                    <small *ngIf="titulo.errors?.['minlength']">Mínimo 3 caracteres</small>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Facturación -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-file-invoice me-2 text-primary"></i>Parámetros de Facturación
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                
                <!-- Serie -->
                <div class="col-md-6">
                  <label for="serie" class="form-label">
                    Serie de Facturación <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-hashtag text-muted"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control"
                      id="serie"
                      name="serie"
                      placeholder="001"
                      required
                      [(ngModel)]="config.serie"
                      #serie="ngModel"
                      [class.is-invalid]="serie.invalid && serie.touched"
                    />
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="serie.invalid && serie.touched">
                    <small>La serie es requerida</small>
                  </div>
                  <small class="form-text text-muted">Prefijo para las facturas</small>
                </div>

                <!-- Correlativo -->
                <div class="col-md-6">
                  <label for="correlativo" class="form-label">
                    Correlativo Inicial <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-sort-numeric-up text-muted"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control"
                      id="correlativo"
                      name="correlativo"
                      placeholder="000001"
                      required
                      [(ngModel)]="config.correlativo"
                      #correlativo="ngModel"
                      [class.is-invalid]="correlativo.invalid && correlativo.touched"
                    />
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="correlativo.invalid && correlativo.touched">
                    <small>El correlativo es requerido</small>
                  </div>
                  <small class="form-text text-muted">Número inicial para las facturas</small>
                </div>

              </div>

              <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <small>Las facturas se generarán con el formato: <strong>{{ config.serie }}-{{ config.correlativo }}</strong></small>
              </div>
            </div>
          </div>

          <!-- Categorías -->
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-tags me-2 text-primary"></i>Categorías de Productos
              </h5>
            </div>
            <div class="card-body">
              
              <!-- Agregar nueva categoría -->
              <div class="row g-3 mb-4">
                <div class="col-md-5">
                  <label for="titulo_cat" class="form-label">Nombre de la Categoría</label>
                  <input
                    type="text"
                    class="form-control"
                    id="titulo_cat"
                    name="titulo_cat"
                    placeholder="Ej: Electrónica, Ropa, Hogar..."
                    [(ngModel)]="titulo_cat"
                  />
                </div>
                <div class="col-md-5">
                  <label for="icono_cat" class="form-label">Ícono (clase CSS)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="icono_cat"
                    name="icono_cat"
                    placeholder="Ej: fas fa-laptop, fas fa-tshirt"
                    [(ngModel)]="icono_cat"
                  />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    (click)="agregar_cat()">
                    <i class="fas fa-plus me-1"></i>Agregar
                  </button>
                </div>
              </div>

              <small class="form-text text-muted d-block mb-3">
                <i class="fas fa-lightbulb me-1"></i>
                Usa iconos de Font Awesome. Ejemplo: <code>fas fa-laptop</code>, <code>fas fa-tshirt</code>
              </small>

              <!-- Lista de categorías -->
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 60px;" class="text-center">#</th>
                      <th>Categoría</th>
                      <th>Ícono</th>
                      <th class="text-center" style="width: 100px;">Acciones</th>
                    </tr>
                  </thead>
                  
                  <!-- Empty State -->
                  <tbody *ngIf="!config.categorias || config.categorias.length === 0">
                    <tr>
                      <td colspan="4" class="text-center py-5">
                        <i class="fas fa-tags text-muted mb-3" style="font-size: 3rem; display: block;"></i>
                        <h6 class="text-muted mb-2">No hay categorías registradas</h6>
                        <p class="text-muted small mb-0">Agrega la primera categoría usando el formulario superior</p>
                      </td>
                    </tr>
                  </tbody>

                  <!-- Data Rows -->
                  <tbody *ngIf="config.categorias && config.categorias.length > 0">
                    <tr *ngFor="let item of config.categorias; let i = index">
                      <td class="text-center text-muted small">{{ i + 1 }}</td>
                      <td>
                        <span class="fw-semibold">{{ item.titulo }}</span>
                      </td>
                      <td>
                        <i [class]="item.icono + ' me-2 text-primary'"></i>
                        <code class="small">{{ item.icono }}</code>
                      </td>
                      <td class="text-center">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="button"
                          (click)="abrirModalEliminar(item)"
                          title="Eliminar">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>
          </div>

        </div>

        <!-- Columna Lateral -->
        <div class="col-lg-4">
          
          <!-- Logo -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-image me-2 text-primary"></i>Logo de la Tienda
              </h5>
            </div>
            <div class="card-body">
              
              <!-- Preview del logo -->
              <div class="text-center mb-3">
                <img
                  [src]="imgSelect"
                  alt="Logo preview"
                  class="img-fluid rounded border"
                  style="max-height: 200px; width: 100%; object-fit: contain; background-color: #f8f9fa; padding: 1rem;"
                />
              </div>

              <!-- Input de archivo -->
              <div class="mb-3">
                <label for="logo" class="form-label">Cambiar Logo</label>
                <input
                  #fileInput
                  type="file"
                  class="form-control"
                  id="logo"
                  accept="image/png,image/jpeg,image/jpg,image/webp,image/svg+xml"
                  (change)="fileChangeEvent($event)"
                />
                <small class="form-text text-muted d-block mt-2">
                  Formatos: PNG, JPG, WEBP, SVG<br>
                  Tamaño máximo: 5MB<br>
                  <span class="text-info">Dejar vacío para mantener el logo actual</span>
                </small>
              </div>

            </div>
          </div>

          <!-- Card de Acciones -->
          <div class="card sticky-top" style="top: 90px;">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-save me-2"></i>Guardar Configuración
              </h5>
            </div>
            <div class="card-body">
              
              <!-- Validación del formulario -->
              <div class="alert alert-warning mb-3" *ngIf="confForm.invalid && confForm.touched">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>Completa todos los campos requeridos marcados con <span class="text-danger">*</span></small>
              </div>

              <!-- Botones de acción -->
              <div class="d-grid gap-2">
                <button
                  type="submit"
                  class="btn btn-success btn-lg"
                  [disabled]="confForm.invalid || load_btn">
                  <span *ngIf="!load_btn">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                  </span>
                  <span *ngIf="load_btn">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Guardando...
                  </span>
                </button>
              </div>

              <!-- Información adicional -->
              <hr class="my-3">
              <div class="small text-muted">
                <p class="mb-2">
                  <i class="fas fa-asterisk fa-xs me-2"></i>
                  Los campos marcados son obligatorios
                </p>
                <p class="mb-2">
                  <i class="fas fa-exclamation-circle fa-xs me-2"></i>
                  Los cambios afectarán todo el sistema
                </p>
                <p class="mb-0">
                  <i class="fas fa-shield-alt fa-xs me-2"></i>
                  Asegúrate de revisar antes de guardar
                </p>
              </div>

            </div>
          </div>

        </div>

      </div>

    </form>

  </div>
</main>

<!-- Modal de Confirmación para Eliminar Categoría -->
<div 
  class="modal fade" 
  id="deleteModal" 
  tabindex="-1" 
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" *ngIf="categoriaAEliminar">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle text-danger me-2"></i>
          Confirmar Eliminación
        </h5>
        <button 
          type="button" 
          class="btn-close" 
          (click)="cerrarModal()"
          aria-label="Close">
        </button>
      </div>
      <div class="modal-body">
        <p class="mb-3">¿Estás seguro de eliminar esta categoría?</p>
        <div class="alert alert-warning mb-0">
          <div class="d-flex align-items-center">
            <i [class]="categoriaAEliminar.icono + ' fa-2x text-primary me-3'"></i>
            <div>
              <strong>{{ categoriaAEliminar.titulo }}</strong><br>
              <small class="text-muted">{{ categoriaAEliminar.icono }}</small>
            </div>
          </div>
        </div>
        <div class="alert alert-danger mt-3 mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <small><strong>Advertencia:</strong> Los productos asociados a esta categoría quedarán sin categoría.</small>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="cerrarModal()">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-danger"
          (click)="confirmarEliminacion()">
          <i class="fas fa-trash-alt me-1"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>