<app-sidebar></app-sidebar>

<main class="admin-content">
  <div class="admin-main">

    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3 border-bottom">
      <div class="mb-3 mb-md-0">
        <h1 class="h2 mb-2">
          <i class="fas fa-chart-line me-2 text-primary"></i>Dashboard
        </h1>
        <p class="text-muted mb-0">Análisis y métricas clave de tu tienda</p>
      </div>
      
      <!-- Filtros de Período -->
      <div class="d-flex gap-2 flex-wrap">
        <div class="btn-group" role="group">
          <button 
            type="button" 
            class="btn btn-sm"
            [ngClass]="periodo_seleccionado === 'semana' ? 'btn-primary' : 'btn-outline-primary'"
            (click)="cambiar_periodo('semana')">
            Semana
          </button>
          <button 
            type="button" 
            class="btn btn-sm"
            [ngClass]="periodo_seleccionado === 'mes' ? 'btn-primary' : 'btn-outline-primary'"
            (click)="cambiar_periodo('mes')">
            Mes
          </button>
          <button 
            type="button" 
            class="btn btn-sm"
            [ngClass]="periodo_seleccionado === 'trimestre' ? 'btn-primary' : 'btn-outline-primary'"
            (click)="cambiar_periodo('trimestre')">
            Trimestre
          </button>
          <button 
            type="button" 
            class="btn btn-sm"
            [ngClass]="periodo_seleccionado === 'año' ? 'btn-primary' : 'btn-outline-primary'"
            (click)="cambiar_periodo('año')">
            Año
          </button>
        </div>
      </div>
    </div>

    <!-- Filtro de Fechas Personalizado -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Desde</label>
            <input 
              type="date" 
              class="form-control form-control-sm"
              [(ngModel)]="fecha_inicio" />
          </div>
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Hasta</label>
            <input 
              type="date" 
              class="form-control form-control-sm"
              [(ngModel)]="fecha_fin" />
          </div>
          <div class="col-md-4">
            <button 
              class="btn btn-primary btn-sm w-100"
              (click)="aplicar_filtro_fechas()">
              <i class="fas fa-filter me-1"></i>Aplicar Filtro
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="load_data" class="text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="text-muted">Cargando métricas...</p>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="!load_data">

      <!-- ============================================ -->
      <!-- KPIs PRINCIPALES -->
      <!-- ============================================ -->
      <div class="row g-3 mb-4">
        
        <!-- Ventas Totales -->
        <div class="col-md-6 col-xl-3">
          <div class="card kpi-card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="kpi-icon bg-primary bg-opacity-10 rounded-3 p-3">
                  <i class="fas fa-shopping-cart fa-2x text-primary"></i>
                </div>
                <span class="badge" 
                  [ngClass]="kpis.crecimiento_ventas >= 0 ? 'bg-success' : 'bg-danger'">
                  <i class="fas" 
                    [ngClass]="kpis.crecimiento_ventas >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'">
                  </i>
                  {{ kpis.crecimiento_ventas | number:'1.1-1' }}%
                </span>
              </div>
              <h6 class="text-muted mb-2 small">Ventas Totales</h6>
              <h3 class="mb-1 fw-bold">{{ kpis.ventas_totales }}</h3>
              <small class="text-muted">
                {{ kpis.ventas_mes_actual }} este mes
              </small>
            </div>
          </div>
        </div>

        <!-- Ingresos Totales -->
        <div class="col-md-6 col-xl-3">
          <div class="card kpi-card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="kpi-icon bg-success bg-opacity-10 rounded-3 p-3">
                  <i class="fas fa-dollar-sign fa-2x text-success"></i>
                </div>
                <span class="badge" 
                  [ngClass]="kpis.crecimiento_ingresos >= 0 ? 'bg-success' : 'bg-danger'">
                  <i class="fas" 
                    [ngClass]="kpis.crecimiento_ingresos >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'">
                  </i>
                  {{ kpis.crecimiento_ingresos | number:'1.1-1' }}%
                </span>
              </div>
              <h6 class="text-muted mb-2 small">Ingresos Totales</h6>
              <h3 class="mb-1 fw-bold">{{ kpis.ingresos_totales | currency:'USD':'symbol':'1.0-0' }}</h3>
              <small class="text-muted">
                {{ kpis.ingresos_mes_actual | currency:'USD':'symbol':'1.0-0' }} este mes
              </small>
            </div>
          </div>
        </div>

        <!-- Ticket Promedio -->
        <div class="col-md-6 col-xl-3">
          <div class="card kpi-card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="kpi-icon bg-warning bg-opacity-10 rounded-3 p-3">
                  <i class="fas fa-receipt fa-2x text-warning"></i>
                </div>
              </div>
              <h6 class="text-muted mb-2 small">Ticket Promedio</h6>
              <h3 class="mb-1 fw-bold">{{ kpis.ticket_promedio | currency:'USD' }}</h3>
              <small class="text-muted">
                Por venta realizada
              </small>
            </div>
          </div>
        </div>

        <!-- Productos Vendidos -->
        <div class="col-md-6 col-xl-3">
          <div class="card kpi-card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="kpi-icon bg-info bg-opacity-10 rounded-3 p-3">
                  <i class="fas fa-box-open fa-2x text-info"></i>
                </div>
              </div>
              <h6 class="text-muted mb-2 small">Productos Vendidos</h6>
              <h3 class="mb-1 fw-bold">{{ kpis.productos_vendidos }}</h3>
              <small class="text-muted">
                Unidades totales
              </small>
            </div>
          </div>
        </div>

      </div>

      <!-- ============================================ -->
      <!-- KPIs SECUNDARIOS -->
      <!-- ============================================ -->
      <div class="row g-3 mb-4">
        
        <!-- Clientes Activos -->
        <div class="col-md-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                    <i class="fas fa-users fa-lg text-primary"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="text-muted mb-1 small">Clientes Activos</h6>
                  <h4 class="mb-0 fw-bold">{{ kpis.clientes_activos }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stock Bajo -->
        <div class="col-md-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                    <i class="fas fa-exclamation-triangle fa-lg text-danger"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="text-muted mb-1 small">Stock Bajo</h6>
                  <h4 class="mb-0 fw-bold">{{ kpis.productos_stock_bajo }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cupones Activos -->
        <div class="col-md-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="rounded-circle bg-success bg-opacity-10 p-3">
                    <i class="fas fa-ticket-alt fa-lg text-success"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="text-muted mb-1 small">Cupones Activos</h6>
                  <h4 class="mb-0 fw-bold">{{ kpis.cupones_activos }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tasa de Conversión (Placeholder) -->
        <div class="col-md-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                    <i class="fas fa-chart-pie fa-lg text-warning"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="text-muted mb-1 small">Tasa Conversión</h6>
                  <h4 class="mb-0 fw-bold">{{ kpis.tasa_conversion | number:'1.1-1' }}%</h4>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ============================================ -->
      <!-- GRÁFICOS -->
      <!-- ============================================ -->
      
      <!-- Fila 1: Ventas Mensuales y Ventas por Estado -->
      <div class="row g-4 mb-4">
        
        <!-- Ventas Mensuales -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="chart-container" style="height: 350px;">
                <canvas #ventasMensualesChart></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Ventas por Estado -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="chart-container" style="height: 350px;">
                <canvas #ventasPorEstadoChart></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Fila 2: Productos Top e Ingresos Semanales -->
      <div class="row g-4 mb-4">
        
        <!-- Productos Top -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="chart-container" style="height: 350px;">
                <canvas #productosTopChart></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Ingresos Semanales -->
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="chart-container" style="height: 350px;">
                <canvas #ingresosSemanalesChart></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ============================================ -->
      <!-- TABLA DE PRODUCTOS TOP -->
      <!-- ============================================ -->
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0">
              <h5 class="mb-0">
                <i class="fas fa-star me-2 text-warning"></i>
                Top 5 Productos Más Vendidos
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 60px;">#</th>
                      <th>Producto</th>
                      <th class="text-center">Unidades Vendidas</th>
                      <th class="text-center">Ingresos Generados</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let producto of productos_top; let i = index">
                      <td class="text-center">
                        <span class="badge" 
                          [ngClass]="{
                            'bg-warning': i === 0,
                            'bg-secondary': i === 1,
                            'bg-info': i === 2,
                            'bg-light text-dark': i > 2
                          }">
                          {{ i + 1 }}
                        </span>
                      </td>
                      <td>
                        <div class="fw-semibold">{{ producto.titulo }}</div>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">
                          {{ producto.ventas }} unidades
                        </span>
                      </td>
                      <td class="text-center">
                        <span class="fw-bold text-success">
                          {{ producto.ingresos | currency:'USD' }}
                        </span>
                      </td>
                    </tr>
                    <tr *ngIf="productos_top.length === 0">
                      <td colspan="4" class="text-center py-4 text-muted">
                        No hay datos de productos vendidos
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</main>