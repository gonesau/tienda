<app-sidebar></app-sidebar>

<main class="admin-content">
  <div class="admin-main">

    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 pb-3 border-bottom no-print">
      <div class="mb-3 mb-md-0">
        <h1 class="h2 mb-2">Detalle de la Venta</h1>
        <p class="text-muted mb-0">Información completa de la orden</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" (click)="imprimir()">
          <i class="fas fa-print me-2"></i>Imprimir
        </button>
        <a class="btn btn-outline-primary" [routerLink]="['/panel/ventas']">
          <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
      </div>
    </div>

    <!-- Loading State -->
    <div class="card" *ngIf="load_data">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted mb-0">Cargando detalle de la venta...</p>
      </div>
    </div>

    <!-- Venta no encontrada -->
    <div class="card" *ngIf="!venta && !load_data">
      <div class="card-body text-center py-5">
        <i class="fas fa-shopping-bag text-muted mb-3" style="font-size: 4rem; display: block;"></i>
        <h4 class="mb-3">Venta no encontrada</h4>
        <p class="text-muted mb-4">La venta que buscas no existe o fue eliminada</p>
        <a class="btn btn-primary" [routerLink]="['/panel/ventas']">
          <i class="fas fa-arrow-left me-2"></i>Volver a Ventas
        </a>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div *ngIf="venta && !load_data">

      <div class="row g-4">

        <!-- Columna Principal -->
        <div class="col-lg-8">

          <!-- Card de Información General -->
          <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-info-circle me-2 text-primary"></i>
                Información de la Orden
              </h5>
              <span class="badge" [ngClass]="getEstadoClass(venta.estado)">
                {{ venta.estado }}
              </span>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Número de Orden</h6>
                  <p class="fw-bold text-primary fs-5 mb-0">{{ venta.nventa }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Fecha de Compra</h6>
                  <p class="mb-0">{{ formatearFecha(venta.createdAt) }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">ID de Transacción</h6>
                  <p class="mb-0 font-monospace small">{{ venta.transaccion }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Método de Pago</h6>
                  <p class="mb-0">
                    <i class="fab fa-paypal text-primary me-1"></i>PayPal
                  </p>
                </div>
                <div class="col-12" *ngIf="venta.cupon">
                  <h6 class="text-muted mb-2">Cupón Aplicado</h6>
                  <span class="badge bg-success">
                    <i class="fas fa-ticket-alt me-1"></i>{{ venta.cupon }}
                  </span>
                </div>
                <div class="col-12" *ngIf="venta.nota">
                  <h6 class="text-muted mb-2">Nota del Cliente</h6>
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-comment me-2"></i>{{ venta.nota }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Card de Cliente -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-user me-2 text-primary"></i>
                Datos del Cliente
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Nombre Completo</h6>
                  <p class="mb-0">{{ venta.cliente.nombres }} {{ venta.cliente.apellidos }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Email</h6>
                  <p class="mb-0">
                    <a [href]="'mailto:' + venta.cliente.email">{{ venta.cliente.email }}</a>
                  </p>
                </div>
                <div class="col-md-6" *ngIf="venta.cliente.telefono">
                  <h6 class="text-muted mb-2">Teléfono</h6>
                  <p class="mb-0">
                    <a [href]="'tel:' + venta.cliente.telefono">{{ venta.cliente.telefono }}</a>
                  </p>
                </div>
                <div class="col-md-6" *ngIf="venta.cliente.dui">
                  <h6 class="text-muted mb-2">DUI</h6>
                  <p class="mb-0">{{ venta.cliente.dui }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Card de Dirección de Envío -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                Dirección de Envío
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <h6 class="text-muted mb-2">Destinatario</h6>
                  <p class="mb-0 fw-semibold">{{ venta.direccion.destinatario }}</p>
                </div>
                <div class="col-12">
                  <h6 class="text-muted mb-2">Dirección Completa</h6>
                  <p class="mb-0">{{ venta.direccion.direccion }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Ciudad/Municipio</h6>
                  <p class="mb-0">{{ venta.direccion.municipio || 'No especificado' }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">País</h6>
                  <p class="mb-0">{{ venta.direccion.pais }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Código Postal</h6>
                  <p class="mb-0">{{ venta.direccion.zip }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">Teléfono de Contacto</h6>
                  <p class="mb-0">
                    <a [href]="'tel:' + venta.direccion.telefono">{{ venta.direccion.telefono }}</a>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Card de Productos -->
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-box-open me-2 text-primary"></i>
                Productos ({{ detalles.length }})
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Producto</th>
                      <th class="text-center d-none d-md-table-cell">Variedad</th>
                      <th class="text-center">Cantidad</th>
                      <th class="text-center d-none d-lg-table-cell">Precio Unit.</th>
                      <th class="text-center">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let detalle of detalles">
                      <td>
                        <div class="d-flex align-items-center">
                          <img 
                            [src]="url + 'obtener_portada/' + detalle.producto.portada"
                            [alt]="detalle.producto.titulo"
                            class="rounded me-3"
                            style="width: 60px; height: 60px; object-fit: cover;"
                            onerror="this.src='assets/img/no-image.png'" />
                          <div>
                            <div class="fw-semibold">{{ detalle.producto.titulo }}</div>
                            <small class="text-muted d-md-none">{{ detalle.variedad }}</small>
                          </div>
                        </div>
                      </td>
                      <td class="text-center d-none d-md-table-cell">
                        <span class="badge bg-light text-dark">{{ detalle.variedad }}</span>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">{{ detalle.cantidad }}</span>
                      </td>
                      <td class="text-center d-none d-lg-table-cell">
                        {{ (detalle.subtotal / detalle.cantidad) | currency:'USD' }}
                      </td>
                      <td class="text-center fw-bold">
                        {{ detalle.subtotal | currency:'USD' }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>

        <!-- Columna Lateral -->
        <div class="col-lg-4">

          <!-- Card de Resumen -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-calculator me-2"></i>
                Resumen de la Orden
              </h5>
            </div>
            <div class="card-body">
              <!-- Subtotal Productos -->
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Subtotal Productos:</span>
                <span class="fw-semibold">{{ calcularSubtotalProductos() | currency:'USD' }}</span>
              </div>

              <!-- Envío -->
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Envío:</span>
                <span class="fw-semibold">{{ venta.envio_precio | currency:'USD' }}</span>
              </div>
              <div class="mb-3">
                <small class="text-muted">
                  <i class="fas fa-truck me-1"></i>{{ venta.envio_titulo }}
                </small>
              </div>

              <!-- Descuento (si aplica) -->
              <div class="d-flex justify-content-between mb-2" *ngIf="calcularDescuento() > 0">
                <span class="text-danger">Descuento:</span>
                <span class="fw-semibold text-danger">-{{ calcularDescuento() | currency:'USD' }}</span>
              </div>
              <div class="mb-3" *ngIf="venta.cupon">
                <small class="text-muted">
                  <i class="fas fa-ticket-alt me-1"></i>Cupón: {{ venta.cupon }}
                </small>
              </div>

              <hr>

              <!-- Total -->
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">TOTAL:</h5>
                <h4 class="mb-0 text-primary fw-bold">{{ venta.subtotal | currency:'USD' }}</h4>
              </div>
            </div>
          </div>

          <!-- Card de Acciones -->
          <div class="card no-print">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-cog me-2 text-primary"></i>
                Acciones
              </h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button 
                  class="btn btn-warning"
                  (click)="abrirModalEstado()">
                  <i class="fas fa-edit me-2"></i>Cambiar Estado
                </button>
                <button 
                  class="btn btn-outline-primary"
                  (click)="imprimir()">
                  <i class="fas fa-print me-2"></i>Imprimir Orden
                </button>
                <a 
                  class="btn btn-outline-secondary"
                  [routerLink]="['/panel/ventas']">
                  <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                </a>
              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>
</main>

<!-- Modal Cambiar Estado -->
<div class="modal fade" id="estadoModal" tabindex="-1" aria-labelledby="estadoModalLabel" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" *ngIf="venta">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="estadoModalLabel">
          <i class="fas fa-edit text-warning me-2"></i>
          Cambiar Estado de la Orden
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalEstado()" [disabled]="load_btn_estado">
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <strong>Orden:</strong> {{ venta.nventa }}<br>
          <strong>Cliente:</strong> {{ venta.cliente.nombres }} {{ venta.cliente.apellidos }}<br>
          <strong>Estado actual:</strong> 
          <span class="badge ms-1" [ngClass]="getEstadoClass(venta.estado)">
            {{ venta.estado }}
          </span>
        </div>

        <div class="mb-3">
          <label for="nuevoEstado" class="form-label">Nuevo Estado</label>
          <select 
            class="form-select" 
            id="nuevoEstado"
            [(ngModel)]="nuevoEstado">
            <option value="">Seleccionar...</option>
            <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
          </select>
        </div>

        <div class="alert alert-warning mb-0">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <small>El cliente será notificado del cambio de estado</small>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalEstado()" [disabled]="load_btn_estado">
          Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="actualizarEstado()" [disabled]="load_btn_estado">
          <span *ngIf="!load_btn_estado">
            <i class="fas fa-save me-1"></i>Actualizar
          </span>
          <span *ngIf="load_btn_estado">
            <span class="spinner-border spinner-border-sm me-1"></span>
            Actualizando...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>